# -----------------------------
#   FACH HINZUFÜGEN
# -----------------------------
@app.route("/add_lesson", methods=["GET", "POST"])
@login_required
def add_lesson():
    if request.method == "POST":
        subject = request.form["subject"]
        teacher_name = request.form["teacher"]
        room_number = request.form["room"]
        weekday = request.form["weekday"]
        start = request.form["start"]
        end = request.form["end"]

        # Wochentag von Zahl → Text
        tage = {
            "1": "Montag",
            "2": "Dienstag",
            "3": "Mittwoch",
            "4": "Donnerstag",
            "5": "Freitag"
        }
        tag = tage[weekday]

        # 1. Lehrer speichern oder finden
        teacher = Lehrer.query.filter_by(name=teacher_name).first()
        if not teacher:
            teacher = Lehrer(name=teacher_name)
            db.session.add(teacher)
            db.session.commit()

        # 2. Raum speichern oder finden
        room = Raum.query.filter_by(raumnummer=room_number).first()
        if not room:
            room = Raum(raumnummer=room_number)
            db.session.add(room)
            db.session.commit()

        # 3. Fach speichern oder finden
        fach = Faecher.query.filter_by(
            fachname=subject,
            lehrer_id=teacher.id,
            raum_id=room.id
        ).first()

        if not fach:
            fach = Faecher(
                fachname=subject,
                lehrer_id=teacher.id,
                raum_id=room.id
            )
            db.session.add(fach)
            db.session.commit()

        # 4. Stundenplan-Eintrag speichern
        eintrag = Stundenplan(
            schueler_id=current_user.id,
            fach_id=fach.id,
            tag=tag,
            startzeit=start,
            endzeit=end
        )
        db.session.add(eintrag)
        db.session.commit()

        return redirect(url_for("week_view"))

    return render_template("add_lesson.html")


# -----------------------------
#   STUNDENPLAN ANZEIGEN
# -----------------------------
@app.route("/week_view")
@login_required
def week_view():
    eintraege = (
        db.session.query(Stundenplan, Faecher, Lehrer, Raum)
        .join(Faecher, Stundenplan.fach_id == Faecher.id)
        .join(Lehrer, Faecher.lehrer_id == Lehrer.id)
        .join(Raum, Faecher.raum_id == Raum.id)
        .filter(Stundenplan.schueler_id == current_user.id)
        .all()
    )

    wochentage = ["Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag"]
    stundenplan = {tag: [] for tag in wochentage}

    for sp, fach, lehrer, raum in eintraege:
        stundenplan[sp.tag].append({
            "fachname": fach.fachname,
            "lehrer": lehrer.name,
            "raum": raum.raumnummer,
            "startzeit": sp.startzeit.strftime("%H:%M"),
            "endzeit": sp.endzeit.strftime("%H:%M")
        })

    return render_template("week_view.html", stundenplan=stundenplan)
