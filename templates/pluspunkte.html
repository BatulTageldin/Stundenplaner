{% extends "base.html" %}

{% block content %}
<h2>Pluspunkte Rechner</h2>

<style>
  .calculator-container {
    background: var(--bg-secondary);
    color: var(--text-primary);
    padding: 25px;
    border-radius: 8px;
    box-shadow: var(--shadow);
    max-width: 800px;
    margin: 0 auto;
  }
  .subject-selector {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border-color);
  }
  .subject-item {
    background: var(--bg-primary);
    color: var(--text-primary);
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 6px;
  }
  .subject-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
  }
  .subject-weight-row {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
    padding: 10px;
    background: #e3f2fd;
    border-radius: 4px;
    font-weight: 500;
  }
  [data-theme="dark"] .subject-weight-row {
    background: #1e3a5f;
  }
  .fachnote-display {
    padding: 10px;
    background: #fff3cd;
    border-radius: 4px;
    margin-bottom: 10px;
    font-weight: 600;
    text-align: center;
  }
  [data-theme="dark"] .fachnote-display {
    background: #3d3520;
    color: #ffd700;
  }
  .exam-row {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 10px;
    padding: 10px;
    background: var(--bg-secondary);
    border-radius: 4px;
  }
  .exam-label {
    flex: 0.5;
    font-weight: 500;
  }
  .add-exam-btn, .remove-exam-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
  }
  .add-exam-btn {
    background: #28a745;
    color: white;
  }
  .remove-exam-btn {
    background: #dc3545;
    color: white;
  }
  .subject-name {
    flex: 1;
    font-weight: 600;
    font-size: 16px;
  }
  .grade-input, .exam-weight-input, .subject-weight-input {
    padding: 8px 12px;
    border: 1px solid var(--input-border);
    background: var(--input-bg);
    color: var(--text-primary);
    border-radius: 4px;
    width: 120px;
    font-size: 14px;
  }
  .total-section {
    margin-top: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 8px;
    color: white;
    text-align: center;
  }
  .total-label {
    font-size: 18px;
    margin-bottom: 10px;
  }
  .total-value {
    font-size: 36px;
    font-weight: bold;
  }
  .no-subjects {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary);
  }
  label {
    display: block;
    margin-bottom: 5px;
    font-size: 13px;
    color: var(--text-secondary);
  }
</style>

{% if subjects %}
<div class="calculator-container">
  <div class="subject-selector">
    <h4>Wähle deine Fächer aus:</h4>
    {% for subject in subjects %}
    <label style="display: flex; align-items: center; padding: 10px; background: #f8f9fa; margin-bottom: 8px; border-radius: 4px; cursor: pointer;">
      <input type="checkbox" class="subject-checkbox" value="{{ subject.fachname }}" style="margin-right: 10px; width: 18px; height: 18px;">
      <span style="font-weight: 500;">{{ subject.fachname }}</span>
    </label>
    {% endfor %}
  </div>

  <div id="selectedSubjects"></div>

  <div class="total-section">
    <div class="total-label">Gesamt Pluspunkte</div>
    <div class="total-value" id="totalPoints">0.00</div>
  </div>
</div>

<script>
  const checkboxes = document.querySelectorAll('.subject-checkbox');
  const selectedSubjectsDiv = document.getElementById('selectedSubjects');
  const totalPointsDisplay = document.getElementById('totalPoints');
  const savedData = {};  // Empty object for now, will be populated later when save functionality is added

  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectedSubjects);
  });

  function updateSelectedSubjects() {
    selectedSubjectsDiv.innerHTML = '';
    
    checkboxes.forEach(checkbox => {
      if (checkbox.checked) {
        const subjectName = checkbox.value;
        const subjectDiv = createSubjectRow(subjectName);
        selectedSubjectsDiv.appendChild(subjectDiv);
      }
    });

    calculateTotal();
  }

  function createSubjectRow(subjectName) {
    const div = document.createElement('div');
    div.className = 'subject-item';
    div.dataset.subject = subjectName;

    // Load saved data for this subject
    const subjectData = savedData[subjectName] || { fach_gewichtung: 1.0, pruefungen: [] };
    const hasSavedData = subjectData.pruefungen.length > 0;

    div.innerHTML = `
      <div class="subject-header">
        <div class="subject-name">${subjectName}</div>
        <button class="add-exam-btn" onclick="addExam(this)">+ Prüfung hinzufügen</button>
      </div>
      <div class="subject-weight-row">
        <span>Fach-Gewichtung:</span>
        <input type="number" class="subject-weight-input" placeholder="z.B. 1" step="0.5" min="0.5" value="${subjectData.fach_gewichtung}" style="width: 100px; padding: 5px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-primary); border-radius: 4px;">
      </div>
      <div class="exams-container">
        ${hasSavedData ? '' : `
        <div class="exam-row">
          <div class="exam-label">Prüfung 1</div>
          <div>
            <label>Note</label>
            <input type="number" class="grade-input" placeholder="z.B. 4.5" step="0.5" min="1" max="6" value="4.0">
          </div>
          <div>
            <label>Prüfungs-Gewichtung</label>
            <input type="number" class="exam-weight-input" placeholder="z.B. 1" step="0.5" min="0.5" value="1">
          </div>
        </div>
        `}
      </div>
      <div class="fachnote-display">
        Fachnote: <span class="fachnote-value">4.00</span> → 
        Pluspunkte: <span class="subject-points">0.00</span>
      </div>
    `;

    // Load saved exams if they exist
    if (hasSavedData) {
      const examsContainer = div.querySelector('.exams-container');
      subjectData.pruefungen.forEach((pruefung, index) => {
        const examRow = document.createElement('div');
        examRow.className = 'exam-row';
        examRow.innerHTML = `
          <div class="exam-label">Prüfung ${index + 1}</div>
          <div>
            <label>Note</label>
            <input type="number" class="grade-input" placeholder="z.B. 4.5" step="0.5" min="1" max="6" value="${pruefung.note}">
          </div>
          <div>
            <label>Prüfungs-Gewichtung</label>
            <input type="number" class="exam-weight-input" placeholder="z.B. 1" step="0.5" min="0.5" value="${pruefung.gewichtung}">
          </div>
          ${index > 0 ? '<button class="remove-exam-btn" onclick="removeExam(this)">✕</button>' : ''}
        `;
        examsContainer.appendChild(examRow);
      });
    }

    const inputs = div.querySelectorAll('.grade-input, .exam-weight-input, .subject-weight-input');
    inputs.forEach(input => {
      input.addEventListener('input', () => calculateSubject(div));
    });

    calculateSubject(div);
    return div;
  }

  function addExam(button) {
    const subjectItem = button.closest('.subject-item');
    const examsContainer = subjectItem.querySelector('.exams-container');
    const examCount = examsContainer.querySelectorAll('.exam-row').length;

    const examRow = document.createElement('div');
    examRow.className = 'exam-row';
    examRow.innerHTML = `
      <div class="exam-label">Prüfung ${examCount + 1}</div>
      <div>
        <label>Note</label>
        <input type="number" class="grade-input" placeholder="z.B. 4.5" step="0.5" min="1" max="6" value="4.0">
      </div>
      <div>
        <label>Prüfungs-Gewichtung</label>
        <input type="number" class="exam-weight-input" placeholder="z.B. 1" step="0.5" min="0.5" value="1">
      </div>
      <button class="remove-exam-btn" onclick="removeExam(this)">✕</button>
    `;

    examsContainer.appendChild(examRow);

    const inputs = examRow.querySelectorAll('.grade-input, .exam-weight-input');
    inputs.forEach(input => {
      input.addEventListener('input', () => calculateSubject(subjectItem));
    });

    calculateSubject(subjectItem);
  }

  function removeExam(button) {
    const examRow = button.closest('.exam-row');
    const subjectItem = button.closest('.subject-item');
    examRow.remove();

    const examsContainer = subjectItem.querySelector('.exams-container');
    const examRows = examsContainer.querySelectorAll('.exam-row');
    examRows.forEach((row, index) => {
      row.querySelector('.exam-label').textContent = `Prüfung ${index + 1}`;
    });

    calculateSubject(subjectItem);
  }

  function calculateSubject(subjectDiv) {
    const examRows = subjectDiv.querySelectorAll('.exam-row');
    const subjectWeightInput = subjectDiv.querySelector('.subject-weight-input');
    const fachnoteValue = subjectDiv.querySelector('.fachnote-value');
    const subjectPointsDisplay = subjectDiv.querySelector('.subject-points');

    // Step 1: Calculate weighted average of all exams to get Fachnote
    let totalWeightedGrades = 0;
    let totalExamWeights = 0;

    examRows.forEach(examRow => {
      const gradeInput = examRow.querySelector('.grade-input');
      const examWeightInput = examRow.querySelector('.exam-weight-input');

      const grade = parseFloat(gradeInput.value) || 4.0;
      const examWeight = parseFloat(examWeightInput.value) || 1.0;

      totalWeightedGrades += grade * examWeight;
      totalExamWeights += examWeight;
    });

    const fachnote = totalExamWeights > 0 ? totalWeightedGrades / totalExamWeights : 4.0;
    fachnoteValue.textContent = fachnote.toFixed(2);

    // Step 2: Calculate points based on Fachnote
    let basePoints = 0;
    if (fachnote > 4.0) {
      basePoints = (fachnote - 4.0);
    } else if (fachnote < 4.0) {
      const difference = 4.0 - fachnote;
      basePoints = -(difference * 2);
    }

    // Step 3: Multiply by subject weight
    const subjectWeight = parseFloat(subjectWeightInput.value) || 1.0;
    const calculatedPoints = basePoints * subjectWeight;

    // Step 4: Round to nearest 0.5 (ab 0.25 aufrunden)
    let finalPoints;
    if (calculatedPoints >= 0) {
      finalPoints = Math.floor(calculatedPoints * 2 + 0.5) / 2;
    } else {
      finalPoints = Math.ceil(calculatedPoints * 2 - 0.5) / 2;
    }

    subjectPointsDisplay.textContent = finalPoints.toFixed(1);
    
    // Color coding for the points display
    if (finalPoints > 0) {
      subjectPointsDisplay.style.color = '#155724';
    } else if (finalPoints < 0) {
      subjectPointsDisplay.style.color = '#721c24';
    } else {
      subjectPointsDisplay.style.color = '#000';
    }

    calculateTotal();
  }

  function calculateTotal() {
    const allSubjects = document.querySelectorAll('.subject-item');
    let total = 0;

    allSubjects.forEach(subject => {
      const subjectPointsText = subject.querySelector('.subject-points').textContent;
      total += parseFloat(subjectPointsText) || 0;
    });

    totalPointsDisplay.textContent = total.toFixed(1);

    // Color gradient: green for positive, red for negative
    const totalSection = totalPointsDisplay.parentElement;
    let backgroundColor;
    if (total > 0) {
      const intensity = Math.min(total / 10, 1);
      backgroundColor = `rgb(${Math.round(200 - 140*intensity)}, ${Math.round(230 + 25*intensity)}, ${Math.round(200 - 140*intensity)})`;
    } else if (total < 0) {
      const intensity = Math.min(Math.abs(total) / 10, 1);
      backgroundColor = `rgb(${Math.round(230 + 25*intensity)}, ${Math.round(200 - 140*intensity)}, ${Math.round(200 - 140*intensity)})`;
    } else {
      backgroundColor = '#f8f9fa';
    }
    totalSection.style.backgroundColor = backgroundColor;
  }
</script>

{% else %}
<div class="no-subjects">
  <h3>Keine Fächer gefunden</h3>
  <p>Du musst zuerst Fächer zu deinem Stundenplan hinzufügen.</p>
  <a href="{{ url_for('add_schedule') }}" style="display: inline-block; margin-top: 20px; padding: 10px 20px; background: #5cb85c; color: white; text-decoration: none; border-radius: 4px;">
    Fach zum Stundenplan hinzufügen
  </a>
</div>
{% endif %}

{% endblock %}